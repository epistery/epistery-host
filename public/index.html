<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epistery Host - {DOMAIN}</title>
    <link rel="stylesheet" href="/style/static.css">
    <style>
        .agent-name {
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <header>
        <nav class="container">
            <a href="/" class="logo">
                <span class="logo-text">Epistery Host</span>
            </a>
        </nav>
    </header>

    <main class="console-layout">
        <div class="console-main">
            <div class="console-header">
                <h1>{DOMAIN}</h1>
                <p class="console-tagline">Epistery agent services for this domain</p>
            </div>

            <!-- Server Status Panel -->
            <section class="console-panel">
                <div class="panel-header-row">
                    <h2>Server Status</h2>
                    <button id="admin-button" class="console-btn panel-header-btn">Administrate</button>
                </div>
                <div class="status-row">
                    <span class="status-label">Domain:</span>
                    <span class="status-value">{DOMAIN}</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Server Wallet:</span>
                    <span class="status-value mono">{SERVER_WALLET}</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Status:</span>
                    <span class="status-value">Active</span>
                </div>
            </section>

            <!-- Browser Status Panel -->
            <section class="console-panel">
                <div class="panel-header-row">
                    <h2>Browser Status</h2>
                    <button id="browser-wallet-button" class="console-btn panel-header-btn">Browser Wallet</button>
                </div>
                <div class="status-row">
                    <span class="status-label">Client Wallet:</span>
                    <span class="status-value mono" id="client-wallet">Loading...</span>
                </div>
                <div class="status-info" id="owner-notice" style="display: none;">
                    <p><strong>✓ Domain Owner</strong> - This address is authorized to administrate this domain</p>
                </div>
            </section>

            <!-- Active Agents Panel -->
            <section class="console-panel">
                <h2>Active Agents</h2>
                <div id="agents-container">
                    <div class="status-info">
                        <p>Loading agents...</p>
                    </div>
                </div>
            </section>
        </div>

        <aside class="console-sidebar">
            <nav class="sidebar-nav">
                <section class="sidebar-section">
                    <h3 class="sidebar-heading">About This Host</h3>
                    <div class="sidebar-content">
                        <p>This is an Epistery Host providing agent services for <strong>{DOMAIN}</strong>.</p>

                        <h4>What is this?</h4>
                        <p>The Epistery Host implements a plugin model that launches chosen modules to add routes and wield the domain key.</p>

                        <h4>Available Modules</h4>
                        <ul>
                            <li><strong>Secrets Manager</strong> - Secure credential storage</li>
                            <li><strong>Auth Manager</strong> - Identity and access control</li>
                            <li><strong>Advertising Network</strong> - Ad contract management</li>
                            <li><strong>Domain Credits</strong> - Usage tracking and billing</li>
                        </ul>

                        <h4>For Developers</h4>
                        <p>Learn more about Epistery and how to integrate with this host.</p>
                        <a href="https://epistery.com" class="sidebar-link">Epistery Documentation →</a>
                    </div>
                </section>
            </nav>
        </aside>
    </main>

    <footer>
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2025 Rootz Corp. Open source under MIT License.</p>
                <div class="footer-links">
                    <span>|</span>
                    <a href="https://github.com/epistery/host" target="_blank">GitHub</a>
                    <span>|</span>
                    <a href="https://epistery.com">Epistery</a>
                </div>
            </div>
        </div>
    </footer>

    <script type="module">
        // Check if user is whitelisted for admin access
        async function checkAdminAccess() {
            try {
                // Try to load epistery witness
                const WitnessModule = await import('/lib/witness.js');
                const Witness = WitnessModule.default;
                const witness = await Witness.connect();
                const status = witness.getStatus();

                // Display client wallet
                const clientWallet = status.client.address;
                document.getElementById('client-wallet').textContent = clientWallet;

                // Check if user address is whitelisted (this will be a server API call)
                const response = await fetch('/api/check-admin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address: clientWallet })
                });

                const data = await response.json();
                if (data.isAdmin) {
                    document.getElementById('admin-button').style.display = 'inline-block';
                    document.getElementById('owner-notice').style.display = 'block';
                }
            } catch (error) {
                console.log('Admin check not available:', error.message);
                document.getElementById('client-wallet').textContent = 'Not connected';
            }
        }

        // Button handlers
        document.getElementById('browser-wallet-button')?.addEventListener('click', () => {
            window.location.href = '/status';
        });

        document.getElementById('admin-button')?.addEventListener('click', () => {
            window.location.href = '/admin';
        });

        // Load and display active agents
        async function loadAgents() {
            try {
                const response = await fetch('/api/agents');
                const data = await response.json();
                const container = document.getElementById('agents-container');

                if (!data.agents || data.agents.length === 0) {
                    container.innerHTML = '<div class="status-info"><p>No agents currently active.</p></div>';
                    return;
                }

                let html = '';
                for (const agent of data.agents) {
                    const iconHtml = agent.icon
                        ? `<img src="${agent.icon}" alt="" style="width: 24px; height: 24px; object-fit: contain; margin-right: 8px; vertical-align: middle;">`
                        : '';
                    html += `
                        <div style="padding: var(--spacerhalf) 0; border-bottom: 1px solid var(--page-border);">
                            <div style="margin-bottom: var(--spacerhalf); display: flex; align-items: center;">
                                ${iconHtml}
                                <span class="status-label" style="white-space: nowrap;">${agent.name}</span>
                                <span class="status-value" style="margin-left: 8px;">v${agent.version}</span>
                            </div>
                            <div class="status-info">
                                <p>${agent.description}</p>
                                <p><small>
                                    <a href="${agent.shortPath}/status" target="_blank">${agent.shortPath}/*</a>
                                </small></p>
                            </div>
                        </div>
                    `;
                }
                container.innerHTML = html;
            } catch (error) {
                console.error('Failed to load agents:', error);
                document.getElementById('agents-container').innerHTML =
                    '<div class="status-info"><p>Failed to load agent information.</p></div>';
            }
        }

        // Check admin access on load
        checkAdminAccess();
        loadAgents();
    </script>
</body>
</html>
