<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epistery Host - {DOMAIN}</title>
    <link rel="stylesheet" href="/style/static.css">
    <link rel="icon" type="image/png" href="/image/favicon.png">
    <style>
        .agent-name {
            white-space: nowrap;
        }

        /* Animated pattern background */
        header {
            position: relative;
            overflow: hidden;
        }

        /* Dimmed background layer */
        header::before {
            content: '';
            position: absolute;
            top: -100%;
            left: -100%;
            width: 300%;
            height: 300%;
            background-image: url('/image/epistery-base-1000.png');
            background-size: 1000px 1000px;
            background-repeat: repeat;
            opacity: 0.08;
            animation: patternSwirl 220s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes patternSwirl {
            0% {
                transform: translate(0, 0) scale(1) rotate(0deg);
            }
            25% {
                transform: translate(-80px, 60px) scale(1.5) rotate(3deg);
            }
            50% {
                transform: translate(-40px, -80px) scale(2) rotate(0deg);
            }
            75% {
                transform: translate(60px, -40px) scale(1.5) rotate(-3deg);
            }
            100% {
                transform: translate(0, 0) scale(1) rotate(0deg);
            }
        }

        header nav {
            position: relative;
            z-index: 1;
        }

        /* Logo window - bright clip of the pattern */
        .logo {
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-window {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.1);
            overflow: hidden;
        }

        .logo-window::before {
            content: '';
            position: absolute;
            /* Position to align with header background */
            top: calc(-1 * (var(--header-height, 80px) / 2 - 30px) - 100vh);
            left: calc(-1 * (10px + 2px) - 100vw);
            width: 300vw;
            height: 300vh;
            background-image: url('/image/epistery-base-1000.png');
            background-size: 1000px 1000px;
            background-repeat: repeat;
            opacity: 1;
            animation: patternSwirl 220s ease-in-out infinite;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <header>
        <nav class="container">
            <a href="/?home" class="logo">
                <div class="logo-window"></div>
                <span class="logo-text">Epistery Host</span>
            </a>
            <ul class="nav-menu" id="nav-menu">
                <li><a href="/?home">Home</a></li>
            </ul>
        </nav>
    </header>

    <main class="console-layout">
        <div class="console-main">
            <div class="console-header">
                <h1>{DOMAIN}</h1>
                <p class="console-tagline">Epistery agent services for this domain</p>
            </div>

            <!-- Server Status Panel -->
            <section class="console-panel">
                <div class="panel-header-row">
                    <h2>Server Status</h2>
                    <button id="admin-button" class="console-btn panel-header-btn" style="display: none;">Administrate</button>
                </div>
                <div class="status-row">
                    <span class="status-label">Domain:</span>
                    <span class="status-value">{DOMAIN}</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Chain:</span>
                    <span class="status-value" id="chain-name">Loading...</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Server Wallet:</span>
                    <span class="status-value mono">{SERVER_WALLET}</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Contract:</span>
                    <span class="status-value mono" id="contract-address">Checking...</span>
                </div>
                <div id="init-notice" class="status-info" style="display: none; margin-top: var(--spacerhalf);">
                    <p><strong>⚠️ Not Initialized</strong> - This domain's Agent contract has not been deployed yet. Click Initialize to deploy.</p>
                </div>
            </section>

            <!-- Browser Status Panel -->
            <section class="console-panel">
                <div class="panel-header-row">
                    <h2>Browser Status</h2>
                    <button id="browser-wallet-button" class="console-btn panel-header-btn">Browser Wallet</button>
                </div>
                <div class="status-row">
                    <span class="status-label">Client Wallet:</span>
                    <span class="status-value mono" id="client-wallet">Loading...</span>
                </div>
                <div class="status-info" id="owner-notice" style="display: none;">
                    <p><strong>✓ Domain Owner</strong> - This address is authorized to administrate this domain</p>
                </div>
            </section>

            <!-- Active Agents Panel -->
            <section class="console-panel">
                <h2>Active Agents</h2>
                <div id="agents-container">
                    <div class="status-info">
                        <p>Loading agents...</p>
                    </div>
                </div>
            </section>
        </div>

        <aside class="console-sidebar">
            <nav class="sidebar-nav">
                <section class="sidebar-section">
                    <h3 class="sidebar-heading">About This Host</h3>
                    <div class="sidebar-content">
                        <p>This is an Epistery Host providing agent services for <strong>{DOMAIN}</strong>.</p>

                        <h4>What is this?</h4>
                        <p>The Epistery Host implements a plugin model that launches chosen modules to add routes and wield the domain key.</p>

                        <h4>Available Modules</h4>
                        <ul>
                            <li><strong>Secrets Manager</strong> - Secure credential storage</li>
                            <li><strong>Auth Manager</strong> - Identity and access control</li>
                            <li><strong>Advertising Network</strong> - Ad contract management</li>
                            <li><strong>Domain Credits</strong> - Usage tracking and billing</li>
                        </ul>

                        <h4>For Developers</h4>
                        <p>Learn more about Epistery and how to integrate with this host.</p>
                        <a href="https://epistery.com" class="sidebar-link">Epistery Documentation →</a>
                    </div>
                </section>
            </nav>
        </aside>
    </main>

    <footer>
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2025 Rootz Corp. Open source under MIT License.</p>
                <div class="footer-links">
                    <span>|</span>
                    <a href="https://github.com/epistery/host" target="_blank">GitHub</a>
                    <span>|</span>
                    <a href="https://epistery.com">Epistery</a>
                </div>
            </div>
        </div>
    </footer>

    <script type="module">
        // Check initialization status and update UI
        async function checkInitializationStatus() {
            try {
                const response = await fetch('/', {
                    headers: { 'Accept': 'application/json' }
                });
                const data = await response.json();

                // Update chain name
                document.getElementById('chain-name').textContent = data.server.provider || 'Unknown';

                if (data.server.initialized) {
                    document.getElementById('contract-address').textContent = data.server.contractAddress;
                    document.getElementById('admin-button').textContent = 'Administrate';
                    document.getElementById('admin-button').onclick = () => window.location.href = '/admin';
                } else {
                    document.getElementById('contract-address').textContent = 'uninitialized';
                    document.getElementById('init-notice').style.display = 'block';
                    document.getElementById('admin-button').textContent = 'Initialize';
                    document.getElementById('admin-button').onclick = () => window.location.href = '/initialize';
                    document.getElementById('admin-button').style.display = 'inline-block';
                }
            } catch (error) {
                console.error('Failed to check initialization status:', error);
                document.getElementById('contract-address').textContent = 'Error';
            }
        }

        // Check if user is whitelisted for admin access
        async function checkAdminAccess() {
            try {
                // Try to load epistery witness
                const WitnessModule = await import('/lib/witness.js');
                const Witness = WitnessModule.default;
                const witness = await Witness.connect();
                const status = witness.getStatus();

                // Display client wallet
                const clientWallet = status.client.address;
                document.getElementById('client-wallet').textContent = clientWallet;

                // Check if user address is whitelisted (this will be a server API call)
                const response = await fetch('/api/check-admin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address: clientWallet })
                });

                const data = await response.json();
                if (data.isAdmin) {
                    document.getElementById('admin-button').style.display = 'inline-block';
                    document.getElementById('owner-notice').style.display = 'block';
                }
            } catch (error) {
                console.log('Admin check not available:', error.message);
                document.getElementById('client-wallet').textContent = 'Not connected';
            }
        }

        // Button handlers
        document.getElementById('browser-wallet-button')?.addEventListener('click', () => {
            window.location.href = '/status';
        });

        // Load and display active agents
        async function loadAgents() {
            try {
                const response = await fetch('/api/agents');
                const data = await response.json();
                const container = document.getElementById('agents-container');

                if (!data.agents || data.agents.length === 0) {
                    container.innerHTML = '<div class="status-info"><p>No agents currently active.</p></div>';
                    return;
                }


                let html = '';
                for (const agent of data.agents) {
                    const iconHtml = agent.icon
                        ? `<img src="${agent.icon}" alt="" style="width: 24px; height: 24px; object-fit: contain; margin-right: 8px; vertical-align: middle;">`
                        : '';

                    const widgetHtml = agent.widget
                        ? `<iframe src="${agent.widget}" style="width: 100%; border: none; margin-top: var(--spacerhalf); border-radius: 8px; min-height: 200px;" scrolling="no" onload="this.style.height = this.contentWindow.document.body.scrollHeight + 'px'"></iframe>`
                        : `<div class="status-info">
                               <p>${agent.description}</p>
                               <p><small>
                                   <a href="${agent.shortPath}/status" target="_blank">${agent.shortPath}/*</a>
                               </small></p>
                           </div>`;

                    html += `
                        <div style="padding: var(--spacerhalf) 0; border-bottom: 1px solid var(--page-border);">
                            <div style="margin-bottom: var(--spacerhalf); display: flex; align-items: center;">
                                ${iconHtml}
                                <span class="status-label" style="white-space: nowrap;">${agent.name}</span>
                                <span class="status-value" style="margin-left: 8px;">v${agent.version}</span>
                            </div>
                            ${widgetHtml}
                        </div>
                    `;
                }
                container.innerHTML = html;
            } catch (error) {
                console.error('Failed to load agents:', error);
                document.getElementById('agents-container').innerHTML =
                    '<div class="status-info"><p>Failed to load agent information.</p></div>';
            }
        }

        // Load navigation menu dynamically
        async function loadNavMenu() {
            try {
                const response = await fetch('/api/nav-menu');
                const html = await response.text();
                const nav = document.querySelector('nav.container');
                const existingMenu = document.getElementById('nav-menu');
                if (existingMenu) {
                    existingMenu.remove();
                }
                nav.insertAdjacentHTML('beforeend', html);
            } catch (error) {
                console.error('Failed to load navigation menu:', error);
            }
        }

        // Check initialization and admin access on load
        loadNavMenu();
        checkInitializationStatus();
        checkAdminAccess();
        loadAgents();
    </script>
</body>
</html>
