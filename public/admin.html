<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Domain Administration - Epistery Host</title>
    <script src="/script/common.js"></script>
    <link rel="stylesheet" href="/style/static.css">
    <link rel="icon" type="image/png" href="/image/favicon.png">
    <style>
        .admin-section {
            background: var(--panel-background);
            border: 1px solid var(--page-border);
            border-radius: 8px;
            padding: var(--spacer);
            margin-bottom: var(--spacer);
        }
        .whitelist-item {
            display: grid;
            grid-template-columns: 2fr 1fr auto auto;
            gap: var(--spacerhalf);
            align-items: center;
            padding: var(--spacerhalf);
            border-bottom: 1px solid var(--page-border);
        }
        .whitelist-item:last-child {
            border-bottom: none;
        }
        .address-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .address-text {
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
        }
        .name-input {
            padding: 4px 8px;
            border: 1px solid var(--page-border);
            border-radius: 4px;
            background: var(--page-background);
            color: var(--page-text-primary);
            font-size: 14px;
        }
        .admin-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .admin-toggle input[type="checkbox"] {
            margin: 0;
        }
        .admin-toggle-label {
            min-width: 45px;
            display: inline-block;
        }
        .admin-badge {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .action-buttons {
            display: flex;
            gap: var(--spacerhalf);
        }
        .console-btn.small {
            padding: 4px 12px;
            font-size: 14px;
        }
        .console-btn.danger {
            background: #dc3545;
        }
        .console-btn.danger:hover {
            background: #c82333;
        }
        .add-address-form {
            display: flex;
            gap: var(--spacerhalf);
            margin-top: var(--spacer);
        }
        .add-address-form input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--page-border);
            border-radius: 4px;
            background: var(--page-background);
            color: var(--page-text-primary);
            font-family: monospace;
        }
        .spinner {
            border: 3px solid var(--page-border);
            border-top-color: #007bff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .info-box {
            background: linear-gradient(135deg, rgba(74, 144, 226, 0.08) 0%, rgba(46, 92, 138, 0.12) 100%);
            border: 1px solid rgba(74, 144, 226, 0.2);
            border-radius: 6px;
            padding: var(--spacer);
            margin: var(--spacer) 0;
        }
        .error-box {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.08) 0%, rgba(220, 53, 69, 0.12) 100%);
            border: 1px solid rgba(220, 53, 69, 0.3);
            border-radius: 6px;
            padding: var(--spacer);
            margin: var(--spacer) 0;
        }
        .icon-svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
            vertical-align: middle;
        }
        .console-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: var(--spacerhalf);
        }
        .console-header-left {
            flex: 1;
        }
        .server-balance {
            text-align: right;
            font-size: 14px;
            color: var(--page-text-secondary);
        }
        .server-balance .balance-value {
            font-family: monospace;
            font-weight: bold;
            color: var(--page-text-primary);
        }
        .server-balance .wallet-address {
            font-family: monospace;
            font-size: 11px;
            color: var(--page-text-secondary);
            cursor: pointer;
            word-break: break-all;
            max-width: 200px;
        }
        .server-balance .wallet-address:hover {
            color: var(--page-text-primary);
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <a href="/?home" class="logo">
                <img alt="logo" src="/image/epistery-logo-32.svg" class="logo-window">
            </a>
        </nav>
    </header>

    <main class="console-layout no-sidebar">
        <div class="console-main">
            <div class="console-header">
                <div class="console-header-left">
                    <h1>Domain Administration</h1>
                    <p class="console-tagline">Manage access policy and agents for <span id="domain-name">...</span></p>
                </div>
                <div class="server-balance">
                    <div>Server Wallet</div>
                    <div class="balance-value" id="server-balance">...</div>
                    <div class="wallet-address" id="server-address" onclick="copyToClipboard(this.textContent)" title="Click to copy">...</div>
                </div>
            </div>

            <div id="not-authorized" class="error-box" style="display: none;">
                <h3>⚠️ Not Authorized</h3>
                <p>Your wallet is not whitelisted as an admin for this domain.</p>
                <button class="console-btn" onclick="window.location.href='/'">Return to Home</button>
            </div>

            <div id="admin-content" style="display: none;">
                <!-- Contract Upgrade Section -->
                <section class="admin-section" id="contract-upgrade-section" style="display: none;">
                    <h2>⚡ Contract Upgrade Available</h2>
                    <div id="upgrade-info">
                        <p><strong>Current Version:</strong> <span id="current-version">...</span></p>
                        <p><strong>Available Version:</strong> <span id="expected-version">...</span></p>
                        <p id="upgrade-notes-section" style="display: none;">
                            <strong>Release Notes:</strong>
                            <a id="upgrade-notes-link" href="#" target="_blank">View Release Notes</a>
                        </p>
                        <p class="policy-description" style="margin-top: var(--spacerhalf);">
                            A new version of the Agent contract is available with improved features and bug fixes.
                            Upgrading will deploy a new contract instance.
                        </p>
                    </div>
                    <button class="console-btn" style="margin-top: var(--spacer);" onclick="upgradeContract()">
                        Deploy New Contract
                    </button>
                    <div id="upgrade-progress" style="display: none; margin-top: var(--spacer);">
                        <div class="spinner"></div>
                        <span id="upgrade-progress-text">Deploying new contract...</span>
                    </div>
                </section>

                <!-- Agent Management Section -->
                <section class="admin-section" id="agent-management-section">
                    <h2>Agent Management</h2>
                    <p>Select and configure agents for this domain</p>

                    <div id="agents-loading" style="display: block;">
                        <div class="spinner"></div>
                        <span>Loading agents...</span>
                    </div>

                    <div id="agents-container" style="display: none;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid var(--page-border);">
                                    <th style="text-align: left; padding: var(--spacerhalf);">Agent</th>
                                    <th style="text-align: center; padding: var(--spacerhalf);">Enabled</th>
                                    <th style="text-align: center; padding: var(--spacerhalf);">Default</th>
                                    <th style="text-align: center; padding: var(--spacerhalf);">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="agent-items"></tbody>
                        </table>
                    </div>
                </section>

                <!-- Pending Access Requests Section -->
                <section class="admin-section" id="pending-requests-section" style="display: none;">
                    <h2>Pending Access Requests</h2>
                    <p>Review and approve access requests from users</p>

                    <div id="pending-requests-loading" style="display: none;">
                        <div class="spinner"></div>
                        <span>Loading requests...</span>
                    </div>

                    <div id="pending-requests-container">
                        <div id="pending-requests-items"></div>
                    </div>
                </section>

                <!-- Whitelist Management Section -->
                <section class="admin-section">
                    <h2>Whitelist Management</h2>
                    <p>Manage addresses authorized to access this domain</p>

                    <!-- List Selector -->
                    <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                        <label for="list-selector" style="font-weight: bold;">List:</label>
                        <select id="list-selector" style="flex: 1; padding: 8px; border: 1px solid var(--page-border); border-radius: 4px; background: var(--bg-color);">
                            <option value="">Loading lists...</option>
                        </select>
                        <button class="console-btn" onclick="createNewList()">New List</button>
                    </div>

                    <div id="whitelist-loading" style="display: block;">
                        <div class="spinner"></div>
                        <span>Loading whitelist...</span>
                    </div>

                    <div id="whitelist-error" class="error-box" style="display: none;">
                        <p id="whitelist-error-text"></p>
                    </div>

                    <div id="whitelist-container" style="display: none;">
                        <div id="whitelist-items"></div>

                        <div class="add-address-form">
                            <input type="text" id="new-address" placeholder="0x..." />
                            <input type="text" id="new-name" placeholder="Name (optional)" style="flex: 1 0 200px;" />
                            <label class="admin-toggle">
                                <input type="checkbox" id="new-is-admin" checked onchange="updateNewAdminLabel(this)" />
                                <span class="admin-toggle-label" id="new-admin-label">Admin</span>
                            </label>
                            <button class="console-btn" id="add-address-btn" onclick="addAddress()">Add Address</button>
                        </div>
                        <div id="add-progress" style="display: none; margin-top: var(--spacerhalf);">
                            <div class="spinner"></div>
                            <span id="add-progress-text">Adding address to whitelist...</span>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2025 Rootz Corp. Open source under MIT License.</p>
            </div>
        </div>
    </footer>

    <script type="module">
        let currentPolicy = 'public';
        let whitelist = [];
        let whitelistMetadata = {}; // {address: {name: string, isAdmin: boolean}}
        let contractAddress = null;
        let currentListName = '';
        let availableLists = [];

        async function checkAdminAccess() {
            try {
                // Get domain info
                const statusResponse = await fetch('/', {
                    headers: { 'Accept': 'application/json' }
                });
                const statusData = await statusResponse.json();

                document.getElementById('domain-name').textContent = window.location.hostname;
                contractAddress = statusData.server.contractAddress;

                if (!contractAddress) {
                    showNotAuthorized('Domain not initialized');
                    return;
                }

                // Load epistery witness to get client wallet
                const WitnessModule = await import('/lib/witness.js');
                const Witness = WitnessModule.default;
                const witness = await Witness.connect();
                const status = witness.getStatus();
                const clientAddress = status.client.address;

                // Check if user is admin
                const checkResponse = await fetch('/api/check-admin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address: clientAddress })
                });

                const checkData = await checkResponse.json();

                if (!checkData.isAdmin) {
                    showNotAuthorized();
                    return;
                }

                // User is authorized, show admin content
                document.getElementById('admin-content').style.display = 'block';
                await loadAgents();
                await loadLists();
                await loadPendingRequests();
                await checkContractVersion();

            } catch (error) {
                console.error('Failed to check admin access:', error);
                showNotAuthorized('Error checking authorization');
            }
        }

        function showNotAuthorized(message = null) {
            document.getElementById('not-authorized').style.display = 'block';
            if (message) {
                document.getElementById('not-authorized').querySelector('p').textContent = message;
            }
        }

        async function loadServerBalance() {
            const balanceEl = document.getElementById('server-balance');
            const addressEl = document.getElementById('server-address');
            try {
                const response = await fetch('/api/check-deploy-balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                if (data.error) {
                    balanceEl.textContent = 'Error';
                    addressEl.textContent = '';
                } else {
                    const symbol = data.currencySymbol || 'POL';
                    const balance = parseFloat(data.balance).toFixed(4);
                    balanceEl.textContent = `${balance} ${symbol}`;
                    addressEl.textContent = data.address || '';
                }
            } catch (error) {
                console.error('Failed to load server balance:', error);
                balanceEl.textContent = 'Error';
                addressEl.textContent = '';
            }
        }

        // Load available lists and populate selector
        async function loadLists() {
            try {
                const response = await fetch('/agent/epistery/white-list/lists');
                const data = await response.json();

                availableLists = data.lists || [];
                const selector = document.getElementById('list-selector');

                selector.innerHTML = '';

                // Add epistery::admin as the default list
                const defaultList = 'epistery::admin';

                selector.innerHTML += `<option value="${defaultList}">${defaultList} (Epistery Admin)</option>`;

                // Add other lists
                for (const list of availableLists) {
                    if (list !== defaultList) {
                        selector.innerHTML += `<option value="${list}">${list}</option>`;
                    }
                }

                // Set initial list and load it
                currentListName = defaultList;
                selector.value = currentListName;

                // Add change handler
                selector.onchange = function() {
                    currentListName = this.value;
                    loadWhitelist();
                };

                await loadWhitelist();
            } catch (error) {
                console.error('Failed to load lists:', error);
                // Fallback to epistery::admin list
                currentListName = 'epistery::admin';
                await loadWhitelist();
            }
        }

        async function loadWhitelist() {
            try {
                const listName = currentListName || 'epistery::admin';
                const response = await fetch(`/agent/epistery/white-list/list?list=${encodeURIComponent(listName)}`);

                if (!response.ok) {
                    throw new Error('Failed to load whitelist');
                }

                const data = await response.json();

                whitelist = data.members?.map(m => m.address) || [];
                whitelistMetadata = {};

                // Build metadata from members
                for (const member of (data.members || [])) {
                    whitelistMetadata[member.address.toLowerCase()] = {
                        name: member.name || '',
                        isAdmin: member.role >= 3 // role 3 or higher is admin
                    };
                }

                document.getElementById('whitelist-loading').style.display = 'none';
                document.getElementById('whitelist-container').style.display = 'block';

                renderWhitelist();
            } catch (error) {
                console.error('Failed to load whitelist:', error);
                document.getElementById('whitelist-loading').style.display = 'none';
                document.getElementById('whitelist-error').style.display = 'block';
                document.getElementById('whitelist-error-text').textContent = 'Failed to load whitelist. Check console for details.';
            }
        }

        window.createNewList = async function() {
            const listName = prompt('Enter new list name (e.g., "moderators", "contributors"):');
            if (!listName) return;

            // Just switch to the new list name - it will be created when first member is added
            const selector = document.getElementById('list-selector');
            const option = document.createElement('option');
            option.value = listName;
            option.textContent = listName;
            selector.appendChild(option);
            selector.value = listName;
            currentListName = listName;

            await loadWhitelist();
        };

        function renderWhitelist() {
            const container = document.getElementById('whitelist-items');

            if (whitelist.length === 0) {
                container.innerHTML = '<div class="info-box"><p>No addresses in whitelist</p></div>';
                return;
            }

            // Count admin addresses
            let adminCount = 0;
            for (const address of whitelist) {
                const meta = whitelistMetadata[address.toLowerCase()] || {};
                if (meta.isAdmin !== false) { // Default to admin if not specified
                    adminCount++;
                }
            }

            let html = '';
            for (const address of whitelist) {
                const meta = whitelistMetadata[address.toLowerCase()] || {};
                const isAdmin = meta.isAdmin !== false; // Default to admin
                const name = meta.name || '';
                const canRemove = !(isAdmin && adminCount === 1); // Can't remove last admin
                const canToggleAdmin = !(isAdmin && adminCount === 1); // Can't toggle last admin to non-admin

                html += `
                    <div class="whitelist-item" data-address="${address}">
                        <div class="address-info">
                            <span class="address-text">${address}</span>
                        </div>
                        <div class="name-display">
                            <span class="name-text">${name || '—'}</span>
                            <input type="text" class="name-input" value="${name}" style="display: none;" />
                        </div>
                        <div class="admin-display">
                            <label class="admin-toggle">
                                <input type="checkbox" ${isAdmin ? 'checked' : ''} disabled data-editable="${canToggleAdmin}" />
                                <span class="admin-toggle-label">${isAdmin ? 'Admin' : ''}</span>
                            </label>
                        </div>
                        <div class="action-buttons">
                            <button class="console-btn small" onclick="toggleEdit('${address}')" title="Edit">
                                <span class="edit-icon"><svg class="icon-svg" viewBox="0 0 20 20"><path d="M17.561 2.439c-1.442-1.443-2.525-1.227-2.525-1.227L8.984 7.264 2.21 14.037 1.2 18.799l4.763-1.01 6.774-6.771 6.052-6.052c-.001 0 .216-1.083-1.228-2.527zM5.68 17.32l-1.394.261a3.475 3.475 0 0 0-.261-1.394l1.655 1.133z"/></svg></span>
                                <span class="save-icon" style="display: none;"><svg class="icon-svg" viewBox="0 0 20 20"><path d="M15.173 2H4c-1.101 0-2 .9-2 2v12c0 1.1.899 2 2 2h12c1.101 0 2-.9 2-2V5.127L15.173 2zM14 8c0 .549-.45 1-1 1H7c-.55 0-1-.451-1-1V3h8v5zm-1-4h-2v4h2V4z"/></svg></span>
                            </button>
                            <button class="console-btn small danger" onclick="removeAddress('${address}')" ${!canRemove ? 'disabled title="Cannot remove last admin"' : 'title="Remove"'}>
                                <svg class="icon-svg" viewBox="0 0 20 20"><path d="M6 2l2-2h4l2 2h4v2H2V2h4zM3 6h14l-1 14H4L3 6zm5 2v10h1V8H8zm3 0v10h1V8h-1z"/></svg>
                            </button>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        async function loadPolicy() {
            try {
                const response = await fetch('/api/policy');
                const data = await response.json();

                currentPolicy = data.policy || 'public';
                document.querySelector(`input[name="policy"][value="${currentPolicy}"]`).checked = true;
            } catch (error) {
                console.error('Failed to load policy:', error);
            }
        }

        window.addAddress = async function() {
            const addressInput = document.getElementById('new-address');
            const nameInput = document.getElementById('new-name');
            const isAdminCheckbox = document.getElementById('new-is-admin');
            const addButton = document.getElementById('add-address-btn');
            const progressDiv = document.getElementById('add-progress');
            const progressText = document.getElementById('add-progress-text');

            const address = addressInput.value.trim();
            const name = nameInput.value.trim();
            const isAdmin = isAdminCheckbox.checked;

            if (!address || !address.startsWith('0x')) {
                alert('Please enter a valid Ethereum address');
                return;
            }

            if (whitelist.some(a => a.toLowerCase() === address.toLowerCase())) {
                alert('Address already in whitelist');
                return;
            }

            try {
                // Show loading state
                addButton.disabled = true;
                addressInput.disabled = true;
                nameInput.disabled = true;
                isAdminCheckbox.disabled = true;
                progressDiv.style.display = 'block';
                progressText.textContent = 'Adding address to blockchain...';

                const listName = currentListName || `${window.location.hostname}::admin`;
                const role = isAdmin ? 3 : 2; // 3 = admin, 2 = write/member

                const response = await fetch('/agent/epistery/white-list/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        address: address,
                        listName: listName,
                        name: name,
                        role: role
                    })
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to add address');
                }

                progressText.textContent = 'Address added successfully!';

                // Reload whitelist to get updated data
                await loadWhitelist();

                // Clear inputs
                addressInput.value = '';
                nameInput.value = '';
                isAdminCheckbox.checked = true;

                // Hide progress after a short delay
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                }, 2000);
            } catch (error) {
                console.error('Failed to add address:', error);
                progressDiv.style.display = 'none';
                alert('Failed to add address. Check console for details.');
            } finally {
                // Re-enable inputs
                addButton.disabled = false;
                addressInput.disabled = false;
                nameInput.disabled = false;
                isAdminCheckbox.disabled = false;
            }
        };

        window.removeAddress = async function(address) {
            // Check if this is the last admin
            const meta = whitelistMetadata[address.toLowerCase()] || {};
            const isAdmin = meta.isAdmin !== false;
            let adminCount = 0;
            for (const addr of whitelist) {
                const m = whitelistMetadata[addr.toLowerCase()] || {};
                if (m.isAdmin !== false) adminCount++;
            }

            if (isAdmin && adminCount === 1) {
                alert('Cannot remove the last admin address');
                return;
            }

            if (!confirm(`Remove ${address} from whitelist?`)) {
                return;
            }

            // Find the remove button for this address
            const buttons = document.querySelectorAll('.console-btn.small.danger');
            let removeButton = null;
            for (const btn of buttons) {
                if (btn.getAttribute('onclick')?.includes(address)) {
                    removeButton = btn;
                    break;
                }
            }

            try {
                // Show working indicator
                if (removeButton) {
                    const originalHTML = removeButton.innerHTML;
                    removeButton.innerHTML = '<span style="font-size: 10px;">Removing...</span>';
                    removeButton.disabled = true;

                    const response = await fetch('/api/whitelist/remove', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            address: address,
                            contractAddress: contractAddress
                        })
                    });

                    if (!response.ok) {
                        const data = await response.json();
                        // Restore button on error
                        removeButton.innerHTML = originalHTML;
                        removeButton.disabled = false;
                        throw new Error(data.error || 'Failed to remove address');
                    }

                    // Reload whitelist (button will be re-rendered)
                    await loadWhitelist();
                } else {
                    // Fallback if button not found
                    const response = await fetch('/api/whitelist/remove', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            address: address,
                            contractAddress: contractAddress
                        })
                    });

                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.error || 'Failed to remove address');
                    }

                    await loadWhitelist();
                }
            } catch (error) {
                console.error('Failed to remove address:', error);
                alert('Failed to remove address. Check console for details.');
            }
        };

        window.updateAdminLabel = function(checkbox) {
            const label = checkbox.parentElement.querySelector('.admin-toggle-label');
            label.textContent = checkbox.checked ? 'Admin' : '';
        };

        window.updateNewAdminLabel = function(checkbox) {
            const label = document.getElementById('new-admin-label');
            label.textContent = checkbox.checked ? 'Admin' : '';
        };

        window.toggleEdit = async function(address) {
            const item = document.querySelector(`.whitelist-item[data-address="${address}"]`);
            const nameText = item.querySelector('.name-text');
            const nameInput = item.querySelector('.name-input');
            const adminCheckbox = item.querySelector('.admin-toggle input[type="checkbox"]');
            const adminLabel = item.querySelector('.admin-toggle-label');
            const editIcon = item.querySelector('.edit-icon');
            const saveIcon = item.querySelector('.save-icon');

            // Check if we're in edit mode (save icon is visible)
            if (saveIcon.style.display !== 'none') {
                // Save mode - save changes
                const newName = nameInput.value.trim();
                const newIsAdmin = adminCheckbox.checked;

                // Show working indicator
                const button = item.querySelector('.action-buttons button');
                const originalHTML = saveIcon.innerHTML;
                saveIcon.innerHTML = '<span style="font-size: 10px;">Saving...</span>';
                button.disabled = true;

                try {
                    const listName = currentListName || `${window.location.hostname}::admin`;
                    const response = await fetch('/api/whitelist/update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            address: address,
                            name: newName,
                            isAdmin: newIsAdmin,
                            listName: listName
                        })
                    });

                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.error || 'Failed to update metadata');
                    }

                    // Update local data
                    whitelistMetadata[address.toLowerCase()] = {
                        name: newName,
                        isAdmin: newIsAdmin
                    };

                    // Switch back to view mode
                    nameText.textContent = newName || '—';
                    nameText.style.display = '';
                    nameInput.style.display = 'none';

                    adminCheckbox.disabled = true;
                    adminCheckbox.removeAttribute('onchange');
                    adminLabel.textContent = newIsAdmin ? 'Admin' : '';

                    editIcon.style.display = '';
                    saveIcon.style.display = 'none';
                    saveIcon.innerHTML = originalHTML;
                    button.disabled = false;

                } catch (error) {
                    // Restore button on error
                    saveIcon.innerHTML = originalHTML;
                    button.disabled = false;
                    console.error('Failed to update metadata:', error);
                    alert('Failed to update. Check console for details.');
                }
            } else {
                // Edit mode - enable inputs
                nameText.style.display = 'none';
                nameInput.style.display = 'block';

                const canToggleAdmin = adminCheckbox.getAttribute('data-editable') === 'true';
                if (canToggleAdmin) {
                    adminCheckbox.disabled = false;
                    adminCheckbox.setAttribute('onchange', 'updateAdminLabel(this)');
                }

                editIcon.style.display = 'none';
                saveIcon.style.display = '';
            }
        };

        // Contract version checking and upgrade
        async function checkContractVersion() {
            try {
                const response = await fetch('/.well-known/epistery/contract/version');
                const versionInfo = await response.json();

                if (versionInfo.needsUpgrade) {
                    // Show upgrade section
                    document.getElementById('contract-upgrade-section').style.display = 'block';
                    document.getElementById('current-version').textContent = versionInfo.deployedVersion || 'Unknown (v1.x)';
                    document.getElementById('expected-version').textContent = versionInfo.expectedVersion;

                    // Show release notes link if available
                    if (versionInfo.notes) {
                        document.getElementById('upgrade-notes-section').style.display = 'block';
                        document.getElementById('upgrade-notes-link').href = versionInfo.notes;
                    }
                }
            } catch (error) {
                console.error('Failed to check contract version:', error);
                // Don't show error to user, just log it
            }
        }

        // Pending access requests management
        async function loadPendingRequests() {
            // Always show the section
            document.getElementById('pending-requests-section').style.display = 'block';

            try {
                const response = await fetch('/agent/epistery/white-list/pending-requests', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    const error = await response.json();
                    console.error('Failed to load pending requests:', response.status, error);
                    document.getElementById('pending-requests-items').innerHTML =
                        `<div class="info-box" style="background: rgba(255,0,0,0.1);"><p>Error loading requests: ${error.error || 'Authentication required'}</p></div>`;
                    return;
                }

                const data = await response.json();

                if (data.requests && data.requests.length > 0) {
                    renderPendingRequests(data.requests);
                } else {
                    document.getElementById('pending-requests-items').innerHTML = '<div class="info-box"><p>No pending requests</p></div>';
                }
            } catch (error) {
                console.error('Failed to load pending requests:', error);
                document.getElementById('pending-requests-items').innerHTML =
                    `<div class="info-box" style="background: rgba(255,0,0,0.1);"><p>Error: ${error.message}</p></div>`;
            }
        }

        function renderPendingRequests(requests) {
            const container = document.getElementById('pending-requests-items');

            if (requests.length === 0) {
                container.innerHTML = '<div class="info-box"><p>No pending requests</p></div>';
                return;
            }

            const pendingRequests = requests.filter(r => r.status === 'pending');

            if (pendingRequests.length === 0) {
                container.innerHTML = '<div class="info-box"><p>No pending requests</p></div>';
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';

            pendingRequests.forEach(request => {
                const timestamp = new Date(request.timestamp).toLocaleString();
                const shortAddress = `${request.address.substring(0, 8)}...${request.address.substring(request.address.length - 6)}`;

                html += `
                    <div class="console-section" style="padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <strong>Address:</strong> <code onclick="copyToClipboard('${request.address}')" style="cursor: pointer; text-decoration: underline;" title="Click to copy full address">${shortAddress}</code><br>
                                <strong>List:</strong> ${request.listName}<br>
                                <strong>Agent:</strong> ${request.agentName}<br>
                                <strong>Requested:</strong> ${timestamp}
                            </div>
                        </div>
                        ${request.message ? `<div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 4px;"><em>"${request.message}"</em></div>` : ''}
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="console-btn" onclick="handleApproveRequest('${request.address}', '${request.listName}')" style="background: #28a745;">
                                ✓ Approve
                            </button>
                            <button class="console-btn" onclick="handleDenyRequest('${request.address}', '${request.listName}')" style="background: #dc3545;">
                                ✗ Deny
                            </button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        window.handleApproveRequest = async function(address, listName) {
            const button = event.target;
            const originalText = button.innerHTML;

            try {
                // Show loading state
                button.disabled = true;
                button.innerHTML = '⏳ Approving...';
                button.style.opacity = '0.6';

                const response = await fetch('/agent/epistery/white-list/handle-request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        address,
                        listName,
                        approved: true,
                        role: 2 // write role
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to approve request');
                }

                // Success feedback
                button.innerHTML = '✓ Approved!';
                button.style.background = '#218838';

                setTimeout(async () => {
                    // Reload pending requests and whitelist
                    await loadPendingRequests();
                    await loadWhitelist();
                }, 1000);

            } catch (error) {
                console.error('Failed to approve request:', error);
                alert('Failed to approve request: ' + error.message);

                // Restore button
                button.disabled = false;
                button.innerHTML = originalText;
                button.style.opacity = '1';
            }
        };

        window.handleDenyRequest = async function(address, listName) {
            if (!confirm(`Deny access request from ${address.substring(0, 10)}...?`)) {
                return;
            }

            const button = event.target;
            const originalText = button.innerHTML;

            try {
                // Show loading state
                button.disabled = true;
                button.innerHTML = '⏳ Denying...';
                button.style.opacity = '0.6';

                const response = await fetch('/agent/epistery/white-list/handle-request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        address,
                        listName,
                        approved: false
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to deny request');
                }

                // Success feedback
                button.innerHTML = '✗ Denied';
                button.style.background = '#c82333';

                setTimeout(async () => {
                    // Reload pending requests
                    await loadPendingRequests();
                }, 1000);

            } catch (error) {
                console.error('Failed to deny request:', error);
                alert('Failed to deny request: ' + error.message);

                // Restore button
                button.disabled = false;
                button.innerHTML = originalText;
                button.style.opacity = '1';
            }
        };

        // Copy address to clipboard
        window.copyToClipboard = async function(text) {
            try {
                await navigator.clipboard.writeText(text);
                // Visual feedback - could show a toast notification here
                console.log('Copied to clipboard:', text);
            } catch (error) {
                console.error('Failed to copy:', error);
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
            }
        };

        window.upgradeContract = async function() {
            if (!confirm('Deploy a new Agent contract? This will create a new contract instance with the latest features. Your existing contract will remain unchanged.')) {
                return;
            }

            const progressDiv = document.getElementById('upgrade-progress');
            const progressText = document.getElementById('upgrade-progress-text');
            const upgradeButton = document.querySelector('#contract-upgrade-section button.console-btn');

            try {
                // Show progress
                progressDiv.style.display = 'block';
                upgradeButton.disabled = true;
                progressText.textContent = 'Deploying new contract...';

                // Call deployment API
                const response = await fetch('/api/contract/deploy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        domain: window.location.hostname
                    })
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to deploy contract');
                }

                const result = await response.json();

                progressText.textContent = 'Contract deployed successfully!';

                alert(`Contract deployed successfully!\n\nNew contract address: ${result.address}\n\nThe page will reload to use the new contract.`);

                // Reload the page to pick up new contract
                window.location.reload();

            } catch (error) {
                console.error('Failed to upgrade contract:', error);
                progressDiv.style.display = 'none';
                upgradeButton.disabled = false;
                alert('Failed to deploy new contract: ' + error.message);
            }
        };

        // Load and render agents
        async function loadAgents() {
            try {
                const response = await fetch('/api/agents');
                const data = await response.json();

                const agents = data.agents || [];
                const defaultAgent = data.defaultAgent;

                document.getElementById('agents-loading').style.display = 'none';
                document.getElementById('agents-container').style.display = 'block';

                renderAgents(agents, defaultAgent);
            } catch (error) {
                console.error('Failed to load agents:', error);
                document.getElementById('agents-loading').style.display = 'none';
                document.getElementById('agents-container').innerHTML = '<div class="error-box"><p>Failed to load agents</p></div>';
            }
        }

        function renderAgents(agents, defaultAgent) {
            const container = document.getElementById('agent-items');

            if (agents.length === 0) {
                container.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: var(--spacer);">No agents installed</td></tr>';
                return;
            }

            let html = '';

            for (const agent of agents) {
                // Skip white-list agent
                if (agent.name === '@epistery/white-list') {
                    continue;
                }

                const displayName = agent.title || agent.name;
                const isDefault = defaultAgent === agent.name;
                const isEnabled = agent.enabled !== false; // Default to enabled
                const canBeDefault = !agent.noUserInterface;
                const adminPath = `${agent.shortPath}/admin`;

                html += `
                    <tr style="border-bottom: 1px solid var(--page-border);">
                        <td style="padding: var(--spacer);">
                            <div style="display: flex; align-items: start; gap: var(--spacerhalf);">
                                ${agent.icon ? `<img src="${agent.icon}" style="width: 24px; height: 24px; object-fit: cover;" alt="${displayName}">` : ''}
                                <div>
                                    <strong>${displayName}</strong><br>
                                    <small style="color: var(--text-color-quiet);">${agent.description}</small>
                                </div>
                            </div>
                        </td>
                        <td style="text-align: center; padding: var(--spacer);">
                            <input type="checkbox" ${isEnabled ? 'checked' : ''}
                                   onchange="toggleAgentEnabled('${agent.name}', this.checked)"
                                   ${isDefault ? 'disabled title="Default agent is always enabled"' : ''} />
                        </td>
                        <td style="text-align: center; padding: var(--spacer);">
                            ${canBeDefault ? `
                                <input type="radio" name="default-agent" value="${agent.name}"
                                       ${isDefault ? 'checked' : ''}
                                       onchange="setDefaultAgent('${agent.name}')" />
                            ` : `<small style="color: var(--neutral);">N/A</small>`}
                        </td>
                        <td style="text-align: center; padding: var(--spacer);">
                            <a href="${adminPath}" class="console-btn small" style="text-decoration: none;">Configure</a>
                        </td>
                    </tr>
                `;
            }

            container.innerHTML = html;
        }

        window.toggleAgentEnabled = async function(agentName, enabled) {
            try {
                const response = await fetch('/api/toggle-agent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ agentName, enabled })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to toggle agent');
                }

                // Reload agents to reflect changes
                await loadAgents();
            } catch (error) {
                console.error('Failed to toggle agent:', error);
                alert('Failed to toggle agent: ' + error.message);
                // Reload to reset checkbox
                await loadAgents();
            }
        };

        window.setDefaultAgent = async function(agentName) {
            try {
                const response = await fetch('/api/set-default-agent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ agentName })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to set default agent');
                }

                // Reload agents to reflect changes
                await loadAgents();
            } catch (error) {
                console.error('Failed to set default agent:', error);
                alert('Failed to set default agent: ' + error.message);
                // Reload to reset radio buttons
                await loadAgents();
            }
        };

        // Load page data
        loadServerBalance();
        checkAdminAccess();
    </script>
</body>
</html>
